%\documentclass{amsart}
%\documentclass[aip,graphicx]{revtex4-1}
\documentclass[12pt]{revtex4}
\usepackage{latexsym, color, graphicx, comment}
\usepackage{amssymb}
\usepackage{amsmath}

%\graphicspath{{../MATLAB/}}

\newcommand{\red}[1]{\textcolor{red}{#1}}
\newcommand{\vect}[1]{\mbox{\boldmath $#1$}}
\newcommand{\erf}{\mathrm{erf}}
\newcommand{\PS}{Pfirsch-Schl\"{u}ter~}
\newcommand{\ExB}{\vect{E}\times\vect{B}}
\newcommand{\Cnl}{C_{\mathrm{nl}a}}
\newcommand{\vma}{\vect{v}_{\mathrm{m}a}}
\newcommand{\vm}{\vect{v}_{\mathrm{m}}}
\newcommand{\vda}{\vect{v}_{\mathrm{d}a}}
\newcommand{\vE}{\vect{v}_{E}}
\newcommand{\vdao}{\vect{v}_{\mathrm{d}a0}}
\newcommand{\vdo}{\vect{v}_{\mathrm{d}0}}
\newcommand{\vEo}{\vect{v}_{E0}}
\newcommand{\vpar}{v_{||}}
\newcommand{\vperp}{v_{\bot}}
\newcommand{\rhop}{\rho_{\theta}}
\newcommand{\rT}{r_{T}}
\newcommand{\Ti}{T_{\mathrm{i}}}
\newcommand{\rTi}{r_{T\mathrm{i}}}
\newcommand{\rTe}{r_{T\mathrm{e}}}
\newcommand{\reta}{r_{\eta}}
\newcommand{\rn}{r_{n}}
\newcommand{\rperp}{r_\bot}
\newcommand{\fM}{f_{\mathrm{M}}}
\newcommand{\fMa}{f_{\mathrm{M}a}}
\newcommand{\fMi}{f_{\mathrm{M}i}}
\newcommand{\fMe}{f_{\mathrm{Me}}}
\newcommand{\fe}{f_{\mathrm{e}}}
\newcommand{\Te}{T_{\mathrm{e}}}
\newcommand{\vth}{v_{\mathrm{th}}}
\newcommand{\nuii}{\nu_{ii}}
\newcommand{\nuPrime}{\hat{\nu}}
\newcommand{\gradpar}{\nabla_{||}}
\newcommand{\kpar}{k_{||}}
\newcommand{\psia}{\psi_0}
\newcommand{\psiaHat}{\hat{\psi}_0}
\newcommand{\todo}[1]{\textcolor{red}{To do: #1}}
\newcommand{\changed}[1]{\textcolor{green}{#1}}
\newcommand{\sgn}{\mathrm{sgn}}

\begin{document}

\title{Comparison of particle trajectories and collision operators for collisional transport in nonaxisymmetric plasmas}


% repeat the \author .. \affiliation  etc. as needed
% \email, \thanks, \homepage, \altaffiliation all apply to the current author.
% Explanatory text should go in the []'s,
% actual e-mail address or url should go in the {}'s for \email and \homepage.
% Please use the appropriate macro for the type of information

% \affiliation command applies to all authors since the last \affiliation command.
% The \affiliation command should follow the other information.

\author{M Landreman}
\email[]{mattland@umd.edu}
%\homepage[]{Your web page}
%\thanks{}
\affiliation{Institute for Research in Electronics and Applied Physics, University of Maryland, College Park, MD, 20742, USA}
\author{H M Smith}
\author{P Helander}
\affiliation{Max-Planck-Institut f\"{u}r Plasmaphysik, 17491 Greifswald, Germany}

% Collaboration name, if desired (requires use of superscriptaddress option in \documentclass).
% \noaffiliation is required (may also be used with the \author command).
%\collaboration{}
%\noaffiliation

\date{\today}

\begin{abstract}

Neoclassical phenomena are computed numerically for the LHD and W7-X stellarators using several variants of the drift-kinetic
equation, differing in the terms involving the radial electric field. It is found that
for electric fields below roughly one third of the resonant value, the different formulations give
nearly identical results, demonstrating the incompressible ExB-drift approximation
is quite accurate in this regime. 
However, near the electric field resonance,
the models yield substantially different results.
We also compare results for various collision operators.
In many cases it is found to be important that collisions conserve momentum,
while differences between the full linearized Fokker-Planck operator
and a simpler momentum-conserving model operator are often relatively minor.

\end{abstract}

\pacs{}% insert suggested PACS numbers in braces on next line

\maketitle %\maketitle must follow title, authors, abstract and \pacs


\section{Introduction}

One important difference between axisymmetric and nonaxisymmetric plasmas is that
neoclassical effects in the latter are much more sensitive to small values of the radial
electric field $E_r$. In axisymmetric plasmas, in order for the radial electric to modify the collisional ion heat flux
and other neoclassical phenomena,
the poloidal ion Mach number $(B / B_{pol}) |\vect{v}_E|/v_i$ must approach $\sim 1$,
since an $E_r$ of corresponding magnitude is required to modify the trapped region of phase space\cite{GrishaNeo}.
Here, $B$ is the magnetic field magnitude, $B_{pol}$ is the poloidal magnetic field,
$\vect{v}_E$ is the $\vect{E}\times\vect{B}$ drift, and $v_i=\sqrt{2 T_i/m_i}$ is the ion thermal speed.
However, in nonaxisymmetric plasmas, 
a much smaller value of $E_r$ can modify the collisional fluxes \cite{Galeev, HoKulsrud, BeidlerBigBenchmarking}.
The reason is that helically trapped particles experience a secular radial magnetic drift, and
whichever process first interrupts this radial motion will thereby determine the step size for radial diffusion.
When $E_r=0$, the radial magnetic drift is interrupted by collisions, which cause
the particle to gain parallel momentum and de-trap.
But if $E_r$ is sufficient for the poloidal $\vect{E}\times\vect{B}$
precession frequency to exceed the effective collisional detrapping rate, $\vect{E}\times\vect{B}$ precession
begins to carry helically trapped particles onto untrapped trajectories, thereby limiting the radial step size and transport.
This transition from collisional ($1/\nu$-regime) to $E_r$-limited ($\sqrt{\nu}$-regime) transport
typically occurs at values of $E_r$ for which the poloidal Mach number is still $\ll 1$, due to the low collisionality
in typical experiments. For this reason, stellarator transport is sensitive to small values of $E_r$.

However, including the physics of $\vect{E}\times\vect{B}$ precession in a $\delta f$ drift-kinetic equation (or code to
solve such an equation)
is complicated by several issues.
First, if a rigorous expansion in $\rho_* \ll 1$ is employed, 
$\vect{E}\times\vect{B}$ is formally excluded
when the usual drift ordering $\vect{v}_E \sim \rho_* v_i$ is used,
but the high-flow ordering $\vect{v}_E \sim \rho_*^0 v_i$ is
not a useful ordering either, since it leads to contradictions in a general nonaxisymmetric field \cite{HelanderRotation, SugamaHighFlow}.
Here, $\rho_* = \rho/L$ where $\rho$ is the ion gyroradius and $L$ is a typical
macroscopic scale length.
Second, if the $\vect{v}_{E}$ poloidal precession term
is included in a radially local, time-independent kinetic equation
for $\delta f$ (the departure of the distribution function from a Maxwellian),
unphysical constraints are placed on the distribution function,
as we will prove in section \ref{sec:sources}.
These constraints only appear when $E_r \ne 0$, meaning a small but nonzero
$E_r$ is a singular perturbation of the $E_r=0$ case.
These unphysical behaviors have been elininated in previous codes\cite{BeidlerBigBenchmarking}
by making the ad-hoc replacement $1/B^2 \to 1/\left< B^2 \right>$ (where $\left< \ldots \right>$ denotes
a flux surface average) in the $\vect{E}\times\vect{B}$ drift.
At the same time, variation in the particles' energy and pitch angle associated with $E_r$ is neglected.
These replacements and omissions are chosen so as to restore the variational form of the kinetic equation  \cite{DKES1, DKES2}.
These changes to the kinetic equation may be called the ``incompressible-$\vect{E}\times\vect{B}$-drift''
approximation \cite{Beidler}.
Some investigations have indicated that the incompressible-$\vect{E}\times\vect{B}$-drift
approximation may be reasonably accurate for small $E_r$ but a poor approximation
for larger $E_r$ \cite{Beidler, meMonoenergetic}.
This issue of which collisionless terms to include in the kinetic equation
is effectively a choice between particle trajectories, since the collisionless guiding center trajectories
are equivalent to the characteristic curves of the drift-kinetic equation.

\begin{comment}
If the typical drift ordering $\vect{v}_E \sim \rho_* v_i$ is used,
with the usual ordering of the collision frequency $\nu$ as $\sim \rho_*^0 v_i/L$,
and a rigorous ordering of terms in $\rho_*$ is made, collisionless detrapping is formally
excluded. Here, $\rho_* = \rho/L$ where $\rho$ is the ion gyroradius and $L$ is a typical
macroscopic scale length.  Collisionless detrapping cannot be included by
the alternative ordering $\vect{v}_E \sim v_i$,
since this ordering leads to contradictions in a general nonaxisymmetric field \cite{HelanderRotation, SugamaHighFlow}.
In many stellarator neoclassical calculations and codes, then, the $\rho_*$ ordering is not rigidly followed,
with the $v_E$ poloidal precession term 

To include the physics of collisionless detrapping, $\vect{E}\times\vect{B}$-drift terms
must be retained in the kinetic equation even though these terms are smaller
than other terms in the equation according to the $\rho_* \ll 1$ expansion.
At the same time, the ad-hoc replacement $1/B^2 \to 1/\left< B^2 \right>$ (where $\left< \ldots \right>$ denotes
a flux surface average) is sometimes made in the $\vect{E}\times\vect{B}$ drift \cite{DKES1, DKES2},
since this replacement happens to restore the variational form of the kinetic equation.
This replacement may be called the ``incompressible-$\vect{E}\times\vect{B}$-drift''
approximation \cite{Beidler}.
...
You can think of these various terms as related to effective particle trajectories.
\end{comment}

Another limitation of many past stellarator neoclassical calculations
is that they are often performed with simplified models for collisions \todo{Cite other stellarator codes here}.
The linearized Fokker-Planck collision operator -- the most accurate linear operator available -- 
has been implemented in a variety of 
tokamak neoclassical codes \cite{Sauter0, Sauter, WongChan, NEOFP, speedGrids}.
However, due to the numerical challenge of the extra toroidal dimension in stellarators, 
many stellarator neoclassical codes retain only pitch-angle scattering collisions,
so coupling in the energy dimension is eliminated.
The pitch-angle scattering operator
lacks the momentum conservation property of the Fokker-Planck operator,
which is known to be important in many situations \cite{Briesemeister}.
Several techniques have been devised and implemented \cite{Taguchi2, SugamaNishimura, Maassberg, PENTA}
to effectively restore momentum conservation by post-processing
the transport coefficients obtained with a pure pitch-angle scattering operator,
but these methods will not exactly reproduce calculations with the full linearized Fokker-Planck operator.
The NEO-2 code has implemented the full linearized Fokker-Planck operator for
stellarator geometry \cite{Kernbichler1, Kernbichler2}, but using a field-line-tracing method
which makes it difficult to add the important effect of poloidal $\vect{E}\times\vect{B}$ precession.

Here, we describe a new stellarator neoclassical code
SFINCS (the Stellarator Fokker-Planck Iterative Neoclassical Conservative Solver)
that can be used to explore the aforementioned issues,
comparing various models for effective particle trajectories and collisions.
The code solves the 4D drift-kinetic equation for the distribution function,
retaining coupling in 2 spatial independent variables (toroidal and poloidal angle)
and 2 velocity independent variables (speed and pitch angle),
but neglecting radial coupling.
(For comparison, DKES \cite{DKES1, DKES2} is 3D since energy coupling is neglected, while FORTEC-3D \cite{FORTEC} is 5D since
radial coupling is retained.)
General nonaxisymmetric nested flux surface geometry is allowed,
one or more species may be included, and several models for collisions are available,
including the full inter-species linearized Fokker-Planck operator.
The incompressible-$\vect{E}\times\vect{B}$-drift trajectories are implemented,
as are several other options for trajectories that include the true $\vect{E}\times\vect{B}$ drift.
As we shall demonstrate, retaining the true form of the $\vect{E}\times\vect{B}$
drift comes at a cost, requiring sources/sinks in the kinetic equation
in order for the solutions to be well behaved.
While all of the various options for the particle trajectories have disadvantages,
SFINCS allows the three options to be compared.
As we will show in several calculations for the LHD and W7-X stellarators,
in many experimentally relevant cases,
the transport matrix elements are nearly identical for the various choices of particle trajectories.
However, differences between the trajectory models emerge when the radial electric field
grows comparable to the ``resonant'' value.

In the following section, we motivate the form of the kinetic equation solved by SFINCS,
and detail the three models for particle trajectories that will be compared.
Section \ref{sec:collisionOperators} describes several available models for collisions.
For several of the particle trajectory models,
additional sources/sinks and constraints must be included in the system of equations
for the equations to be well posed and for the solutions to be well behaved.
These issues are explored in section \ref{sec:sources}.
Details of the numerical implementation are given in section \ref{sec:numerics}.
Some of the numerical results presented are given in terms of a transport
matrix, which is defined in section \ref{sec:transportMatrix}.
The numerical results are presented in sections \ref{sec:ErComparison} and \ref{sec:collisionComparison},
in which we discuss the transport matrix elements for the geometries of the LHD and W7-X
stellarators, comparing a variety of assumptions about the particle trajectories and collision operator.
In section \ref{sec:conclusions} we discuss the results and conclude.

\todo{cite EUTERPE and FORTEC-3D}

\section{Kinetic equations}
\label{sec:equations}

We begin with the drift-kinetic equation (19) of Ref. \cite{Hazeltine}.
The standard drift ordering is applied at first: $\rho_* \ll 1$ where $\rho_* = \rho/L$,
$\vE/v_a \sim \rho_*$, $\partial/\partial t \sim \rho_*^2 v_a/L$, and $\nu_a \sim v_a/L$,
where $L$ is a typical scale length.
We expand the distribution function as $f_a = f_{a0} + f_{a1} + \ldots$.
The leading order distribution function $f_{a0}$ is taken to be a Maxwellian
that is constant on flux surfaces when expressed in terms of total energy
$W_a = v^2/2+Z_a e \Phi/m_a$:
\begin{equation}
f_{a0} = \eta_a(\psi) \left[ \frac{m_a}{2\pi T_a(\psi)}\right]^{3/2} \exp\left( -\frac{m_a W_a}{T_a(\psi)}\right).
\label{eq:Maxwellian}
\end{equation}
The mean flow of this Maxwellian is taken to be zero since, as argued in Refs. \cite{HelanderRotation, SugamaHighFlow}, sonic
flows are not permitted in a general stellarator.
Taking $f_{a1}/f_{a0}\sim\rho_*$, the terms of order $\sim\rho_* (v/L)f_{a0}$ in (19) of Ref. \cite{Hazeltine} are then
\begin{equation}
\vpar \vect{b} \cdot\left(\nabla f_{a1}\right)_{W_a,\mu}
-C_{a}
=-\left(\vma + \vE\right)\cdot\nabla\psi \left(\frac{\partial f_{a0}}{\partial \psi}\right)_{W_a}
+\frac{Z_a e}{m_a c}\vpar\vect{b}\cdot\frac{\partial\vect{A}}{\partial t} \frac{\partial f_{a0}}{\partial W_a}
\label{eq:kinetic1}
\end{equation}
where
\begin{equation}
v_{ma}\cdot\nabla\psi = \frac{m_a c v_{||}^2}{Z_a e B} \vect{b}\times (\vect{b}\cdot\nabla\vect{b})\cdot\nabla\psi
+ \frac{m_a c v_{\perp}^2}{2 Z_a e B^2} \vect{b}\times \nabla B \cdot\nabla\psi
=\frac{m_a c}{2 Z_a e B^2}\left(v_{||}^2 + \frac{v_{\bot}^2}{2}\right) \vect{b}\times \nabla B \cdot\nabla\psi
\end{equation}
(exactly true for any $\beta$) and $\vE=(c/B^2)\vect{B}\times\nabla\Phi$.
Here, $C_a$ is the collision term for species $a$, linearized about the Maxwellians (\ref{eq:Maxwellian}).
Subscripts on gradients and partial derivatives indicate the quantities held fixed,
and $\mu=v^2/(2B)$ is the magnetic moment.

Unfortunately, (\ref{eq:kinetic1}) does not contain the physics of $\vect{E}\times\vect{B}$ precession,
since the characteristic curves of this equation correspond only to motion along the magnetic field lines.
Consequently, important transport regimes such as the $\sqrt{\nu}$ regime cannot be obtained
using (\ref{eq:kinetic1}).
To retain $\vect{E}\times\vect{B}$ precession, we also keep the term $(\vE+\vma)\cdot\nabla f_{a1}$
in (\ref{eq:kinetic1}), even though according to the formal ordering it should
appear at next order.  A similar step is made in other stellarator neoclassical
calculations \cite{DKES1, DKES2}

As shown in Appendix C of Ref. \cite{usPedestal}, we may choose the gauge
for the electromagnetic potentials such that $-c^{-1}\vect{b}\cdot\partial\vect{A}/\partial t = \left<E_{||} B\right> B/\left<B^2\right>$
on the right-hand side of (\ref{eq:kinetic1}).
Here, angle brackets denote a flux surface average:
\begin{equation}
\label{eq:FSA}
\left\langle \ldots \right\rangle
=\frac{1}{{V}'}
\int_0^{2\pi }d\theta
\int_0^{2\pi }d\zeta
{\frac{(\ldots)}{\vect{B}\cdot \nabla \zeta }}
\end{equation}
where
${V}'=\int_0^{2\pi } d\theta \int_0^{2\pi } d\zeta / \vect{B}\cdot \nabla \zeta $.
Thus, (\ref{eq:kinetic1}) becomes
\begin{equation}
\left(\vpar \vect{b} + \vE + \vma\right) \cdot\left(\nabla f_{a1}\right)_{W_a,\mu}
-C_{a}
=-\left(\vma + \vE\right)\cdot\nabla\psi \left(\frac{\partial f_{a0}}{\partial \psi}\right)_{W_a}
+\frac{Z_a e}{T_a}\vpar\frac{B\left<E_{||} B\right>}{\left< B^2\right>} f_{a0}.
\label{eq:kinetic2}
\end{equation}
Even if the radial electric field is considered an input, this form of the kinetic equation remains
nonlinear in the unknowns since the $\nabla f_{a1}$ term depends on the variation of $\Phi$
on a flux surface, and this variation is an unknown like $f_{a1}$.

To make the problem linear, we make use of the fact that the potential is nearly a flux function.
We define $\Phi_0 = \left<\Phi\right>$ and $\Phi_1 = \Phi-\Phi_0$.
We assume $\Phi_1 \ll \Phi_0$,
and we will show shortly that this assumption is self-consistent.
Since $e \Phi_0/T_a \sim 1$ in the drift ordering, then $e \Phi_1/T_a \ll 1$.
We do not expand in the ion charge $Z_a$.
Equation (\ref{eq:Maxwellian}) then gives
$f_{a0} \approx F_{a}\left[ 1 - Z_a e \Phi_1/T_a\right]$ where
\begin{equation}
F_{a}=n_a(\psi) \left[\frac{m_a}{2\pi T_a(\psi)}\right]^{3/2}\exp\left(-\frac{m_a v^2}{2 T_a(\psi)}\right)
\end{equation}
and $n_a = \eta_a \exp(-Z_a e \Phi_0/T_a)$ is the leading order density.
We define the leading-order total energy
$W_{a0} =v^2/2+ Z_a e\Phi_0 /m_a$,
and leading-order $\vect{E}\times\vect{B}$ drift
$\vEo=(c/B^2)(d\Phi_0/d\psi)\vect{B}\times\nabla\psi$.
As the relative differences between $f_{a0}$ and $F_a$, between $W_a$ and $W_{a0}$, and between $\vE$ and $\vEo$
are all small, we may replace the former quantities with the latter ones in (\ref{eq:kinetic2}).
At the same time, we note
\begin{equation}
\frac{\vE\cdot\nabla\psi}{\vma\cdot\nabla\psi} \sim \frac{1}{\epsilon} \frac{Z_a e \Phi_1}{T_a}
\label{eq:radialExB}
\end{equation}
where $\epsilon$ is the relative variation of $B$ on a flux surface, and taking this ratio to be small, the $\vE\cdot\nabla\psi$
term in (\ref{eq:kinetic2}) may be neglected. Thus, we obtain
\begin{equation}
\left(\vpar \vect{b} + \vEo + \vma\right) \cdot\left(\nabla f_{a1}\right)_{W_{a0},\mu}
-C_{a}
=-(\vma\cdot\nabla\psi) \left(\frac{\partial F_{a}}{\partial \psi}\right)_{W_{a0}}
+\frac{Z_a e}{T_a}\vpar\frac{B\left<E_{||} B\right>}{\left< B^2\right>} F_{a}.
\label{eq:kinetic3}
\end{equation}
where $C_a$ is now the collision operator linearized about $F_a$ rather than $f_{a0}$,
\begin{equation}
\left(\frac{\partial F_{a}}{\partial \psi}\right)_{W_{a0}}
=\left[ \frac{1}{p_a}\frac{dp_a}{d\psi} + \frac{Z_a e}{T_a} \frac{d\Phi_0}{d\psi} + \left( x_a^2-\frac{5}{2}\right) \frac{1}{T_a} \frac{dT_a}{d\psi}\right]F_a,
\end{equation}
and $x_a = v/v_a$.
If $F_a$ and $\Phi_0$ are considered known, then (\ref{eq:kinetic3}) is now linear in the unknowns $f_{a1}$,
and $\Phi_1$ has decoupled from the kinetic equations.

We note that in some circumstances the ratio (\ref{eq:radialExB}) may not be small \cite{HoKulsrud},
particularly for impurities\cite{Jose} with $Z_a \gg 1$.
However, treating the ratio (\ref{eq:radialExB}) as finite leads to a kinetic equation
that is nonlinear in the unknowns.  We neglect these nonlinear effects of $\Phi_1$ in the present
linear study, but such effects will be important to examine in future work.

For numerical computations, it is convenient to use coordinates for which the ranges of allowed values
are independent of the other coordinates.  As $W_{a0}$ and $\mu$ do not have this property, it is convenient
to switch to coordinates $x_a$ and $\xi = \vpar/v$.  Carrying out this change of variables on the first term
of (\ref{eq:kinetic3}), we find
\begin{equation}
%\left(\vpar \vect{b} + \vEo + \vma\right)
\dot{\vect{r}} \cdot\left(\nabla f_{a1}\right)_{W_{a0},\mu}
=
\dot{\vect{r}}\cdot \left(\nabla f_{a1}\right)_{x_a,\xi}
+\dot{x}_a \left(\frac{\partial f_{a1}}{\partial x_a}\right)_{\vect{r},\xi}
+\dot{\xi}_a \left(\frac{\partial f_{a1}}{\partial \xi}\right)_{\vect{r},x_a}
\end{equation}
where
\begin{equation}
\dot{\vect{r}} = \vpar \vect{b} + \vEo + \vma,
\label{eq:rdot1}
\end{equation}
\begin{equation}
\dot{x}_a = (\vma\cdot\nabla\psi) \left(-\frac{x_a}{2T_a}\frac{dT_a}{d\psi} - \frac{Z_a e}{2T_a x_a}\frac{d\Phi_0}{d\psi}\right),
\label{eq:xdot1}
\end{equation}
and
\begin{equation}
\dot{\xi}_a = -\frac{1-\xi^2}{2 B \xi} \vpar \vect{b}\cdot\nabla B
+\xi(1-\xi^2) \frac{c}{2 B^3} \frac{d\Phi_0}{d\psi}\vect{B}\times\nabla\psi\cdot\nabla B
-\frac{1-\xi^2}{2 B \xi} \vma\cdot\nabla B
.
\label{eq:xidot1}
\end{equation}
For the rest of this work, we will neglect the $\vma$ term in (\ref{eq:rdot1}), the $dT_a/d\psi$ term
in (\ref{eq:xdot1}), and the $\vma\cdot\nabla B$ term in (\ref{eq:xidot1}),
since these terms are small in the $\rho_*$ expansion and do not involve the radial electric field $d\Phi_0/d\psi$.
(The omitted terms may be important in other situations, but here our primary interest is the treatment of the $d\Phi_0/d\psi$ terms.)
Our kinetic equation then becomes
\begin{equation}
\dot{\vect{r}}\cdot \left(\nabla f_{a1}\right)_{x_a,\xi}
+\dot{x}_a \left(\frac{\partial f_{a1}}{\partial x_a}\right)_{\vect{r},\xi}
+\dot{\xi}_a \left(\frac{\partial f_{a1}}{\partial \xi}\right)_{\vect{r},x_a}
-C_{a}
=-(\vma\cdot\nabla\psi) \left(\frac{\partial F_{a}}{\partial \psi}\right)_{W_{a0}}
+\frac{Z_a e}{T_a}\vpar\frac{B\left<E_{||} B\right>}{\left< B^2\right>} F_{a}.
\label{eq:kinetic4}
\end{equation}
where the effective particle trajectory equations are
\begin{eqnarray}
\label{eq:fullTrajectories}
\dot{\vect{r}} &=& \vpar \vect{b} + \frac{c}{B^2}\frac{d\Phi_0}{d\psi} \vect{B}\times\nabla\psi,
\\
\dot{x}_a &=& -(\vma\cdot\nabla\psi) \frac{Z_a e}{2T_a x_a}\frac{d\Phi_0}{d\psi},
\nonumber \\
\dot{\xi}_a &=& -\frac{1-\xi^2}{2 B \xi} \vpar \vect{b}\cdot\nabla B
+\xi(1-\xi^2) \frac{c}{2 B^3} \frac{d\Phi_0}{d\psi}\vect{B}\times\nabla\psi\cdot\nabla B
.\nonumber
\end{eqnarray}
We will refer to (\ref{eq:fullTrajectories}) as the ``full trajectories.''

The $d\Phi_0/d\psi$ terms in $\dot{x}_a$ and $\dot{\xi}_a$ may be interpreted as a finite orbit width effect.
As a particle drifts radially, it experiences a varying electrostatic potential (even if the potential is a flux function.)
Thus the potential energy of the particle changes, so to maintain a constant total energy, the kinetic energy must change at
an equal and opposite rate, giving rise to the $d\Phi/d\psi$ term in $\dot{x}_a$.
Then to conserve $\mu$ while $v$ changes, $\xi$ must also change appropriately,
giving rise to the $d\Phi_0/d\psi$ term in $\dot{\xi}_a$.  Without these $d\Phi_0/d\psi$
terms in $\dot{x}_a$ and $\dot{\xi}$, $\mu$ will not be conserved,
whereas you can verify that $\mu$ is indeed conserved by (\ref{eq:fullTrajectories}).
Note that the $d\Phi_0/d\psi$ term in $\dot{\vect{r}}$
is the same order in the $\rho_*$ expansion as the
$d\Phi_0/d\psi$ terms in $\dot{x}_a$ and $\dot{\xi}_a$,
suggesting that if the former term is retained, the latter terms should be retained as well.

A large number of stellarator neoclassical codes \cite{DKES1, DKES2, BeidlerBigBenchmarking} effectively
solve (\ref{eq:kinetic4}) with the alternative trajectory equations
\begin{eqnarray}
\label{eq:DKESTrajectories}
\dot{\vect{r}} &=& \vpar \vect{b} + \frac{c}{\left<B^2\right>}\frac{d\Phi_0}{d\psi} \vect{B}\times\nabla\psi,
\\
\dot{x}_a &=& 0,
\nonumber \\
\dot{\xi}_a &=& -\frac{1-\xi^2}{2 B \xi} \vpar \vect{b}\cdot\nabla B
.\nonumber
\end{eqnarray}
We refer to these equations as the ``DKES trajectories,'' in light of their use in the widely applied code DKES \cite{DKES1, DKES2}.
These trajectories differ from (\ref{eq:fullTrajectories}) both in the neglect of the $d\Phi_0/d\psi$ terms in $\dot{x}_a$ and $\dot{\xi}_a$,
and in the replacement $B^2 \to \left< B^2 \right>$ in $\dot{\vect{r}}$.
The motivation for approximating the $\vect{E}\times\vect{B}$ drift in this matter will be clarified in section \ref{sec:sources}.
As shown in Refs. \cite{meMonoenergetic, finiteErOmnigenous}, in a symmetric magnetic field, the model (\ref{eq:DKESTrajectories}) possesses a conserved quantity
which is equal to $\mu$ when $d\Phi_0/d\psi=0$ but which differs from $\mu$ when $d\Phi_0/d\psi\neq 0$.

For comparison, we will also consider the following set of trajectory equations:
\begin{eqnarray}
\label{eq:partialTrajectories}
\dot{\vect{r}} &=& \vpar \vect{b} + \frac{c}{B^2}\frac{d\Phi_0}{d\psi} \vect{B}\times\nabla\psi,
\\
\dot{x}_a &=& 0,
\nonumber \\
\dot{\xi}_a &=& -\frac{1-\xi^2}{2 B \xi} \vpar \vect{b}\cdot\nabla B
\nonumber
\end{eqnarray}
which will be referred to as the ``partial trajectories.''  Equations (\ref{eq:partialTrajectories})
represent an intermediate step between (\ref{eq:DKESTrajectories}) and (\ref{eq:fullTrajectories}),
in that (\ref{eq:partialTrajectories}) includes the correct $\vect{E}\times\vect{B}$ drift, but not the
$d\Phi_0/d\psi$ terms in $\dot{x}_a$ and $\dot{\xi}_a$ required to conserve $\mu$.

For all three trajectory models, the quasineutrality equation is effectively decoupled from the kinetic equation (\ref{eq:kinetic4}).
%and it determines $\Phi_1$.
At leading order, quasineutrality implies $\sum_a Z_a n_a = 0$.
At next order, noting that both $f_{a0}$ and $f_{a1}$ contribute to density variation on a flux surface,
\begin{equation}
\sum_a \left( -\frac{Z_a^2 e \Phi_1}{T_a}n_a + Z_a \int d^3v\, f_{a1} \right) = 0.
\end{equation}
This equation may be solved for $\Phi_1$, giving the variation of the potential on a flux surface.
It follows that $e \Phi_1 / T_a \sim f_{a1} / f_{a0} \sim \rho_*$, so our earlier assumption that
$e \Phi_1 / T_a \ll 1$ is self-consistent.

\section{Collision operators}
\label{sec:collisionOperators}

\todo{write this section.}

\section{Conservation properties and sources}
\label{sec:sources}

If one attempts to solve the kinetic equation (\ref{eq:kinetic4}) numerically using either the full or partial trajectories
and $E_r \neq 0$, unphysical results will be obtained, with
the numerical solution not converging as resolution parameters are increased.
We now explore the reason for this behavior.
We will then describe a modified form of the kinetic equation which robustly produces more sensible results.

Consider the result of applying the operation
\begin{equation}
\left< \int d^3v(\ldots)\right>
\label{eq:massConservation}
\end{equation}
to the kinetic equation (\ref{eq:kinetic4}) for each of the trajectory models (\ref{eq:fullTrajectories})-(\ref{eq:partialTrajectories}).
This operation annihilates the streaming and mirror terms, the collision operator, and the
inhomogeneous drive terms.
The operation (\ref{eq:massConservation}) effectively produces a flux-surface-averaged
mass conservation equation for each model.  For the full trajectories and DKES trajectories,
the $d\Phi_0/d\psi$ terms are also annihilated by
(\ref{eq:massConservation}), so the
resulting mass conservation equation is just $0=0$. However, for the partial trajectories, the $d\Phi_0/d\psi$
term ($\vEo\cdot\nabla f_{a1}$) is not annihilated by (\ref{eq:massConservation}),
leaving
\begin{equation}
c \left< \frac{1}{B^2}
\vect{B}\times\nabla\psi\cdot\nabla
\int d^3v\, f_{a1}\right> \frac{d\Phi_0}{d\psi}=0.
\label{eq:unphysicalMassConservation}
\end{equation}
Thus, a nonzero $d\Phi_0/d\psi$ gives a singular perturbation to the $d\Phi_0/d\psi=0$ limit in this partial trajectory model:
the $d\Phi_0/d\psi=0$ solution for $f_{a1}$ need not satisfy 
$\left< (1/B^2) \vect{B}\times\nabla\psi\cdot\nabla\int d^3v\, f_{a1}\right>=0$,
so $f_{a1}$ must change dramatically as $E_r$ is raised from 0 to a small nonzero value,
a behavior which is unphysical.
When $d\Phi_0/d\psi \not= 0$, (\ref{eq:unphysicalMassConservation}) constrains $f_{a1}$ in an unphysical
manner, for there is no analogue to (\ref{eq:unphysicalMassConservation}) in the more accurate
averaged fluid mass conservation equation $0=\left< \partial N_a/\partial t + \nabla\cdot(N_a \vect{V}_a)\right>$
(i.e. the moment of the full Fokker-Planck equation with no expansion in $\rho_*$ or other parameters),
where $N_a$ and $\vect{V}_a$ are the full fluid density and velocity.
The unphysical nature of (\ref{eq:unphysicalMassConservation}) can also be seen from the fact that when the
$d\Phi_0/d\psi$ terms in $\dot{x}_a$ and $\dot{\xi}_a$ are retained in the more accurate trajectories (\ref{eq:fullTrajectories}),
these terms precisely cancel (\ref{eq:unphysicalMassConservation}).

Similarly, we can obtain an averaged energy conservation equation for each trajectory model by applying the operation
\begin{equation}
\sum_a \left< \int d^3v\frac{m_a v^2}{2}(\ldots)\right>
\end{equation}
to (\ref{eq:kinetic4}). Again, the result is $0=0$ for the DKES trajectories. However,
this time both the full and partial trajectory models give nonzero results: the partial trajectories give
\begin{equation}
c \sum_a\left< \frac{1}{B^2}
\vect{B}\times\nabla\psi\cdot\nabla
\int d^3v \frac{m_a v^2}{2} f_{a1}\right> \frac{d\Phi_0}{d\psi}=0.
\label{eq:unphysicalEnergyConservation1}
\end{equation}
and the full trajectories give
\begin{equation}
-c \sum_a\left< \frac{1}{B^2}
\vect{B}\times\nabla\psi\cdot\nabla
\int d^3v \frac{m_a v^2}{2}\frac{(1+\xi^2)}{2} f_{a1}\right> \frac{d\Phi_0}{d\psi}=0.
\label{eq:unphysicalEnergyConservation2}
\end{equation}
The quantity in (\ref{eq:unphysicalEnergyConservation2})
without the $d\Phi_0/d\psi$ factor is proportional to the radial current
$\sum_a Z_a \left< \int d^3v\, f_{a1} v_{ma}\cdot\nabla\psi\right>$,
so it vanishes naturally when $E_r$ is at the ambipolar value.  However, as
the radial current would usually not be zero when $E_r=0$, (\ref{eq:unphysicalEnergyConservation2})
again implies a small nonzero $E_r$ would be a singular perturbation of the
$E_r=0$ limit.

One motivation for use of the DKES trajectory model is now apparent:
it is the only model that avoids the imposition of one or more unphysical
constraints on the distribution function when $d\Phi_0/d\psi \ne 0$,
constraints which cause an $E_r \ne 0$ calculation to be a singular perturbation
of an $E_r = 0$ calculation.
\begin{comment}
if one is forced to drop energy coupling (for reasons of numerical efficiency) by 
neglecting $\dot{x}_a$, unphysical constraints 
would be placed on the distribution function unless the $1/B^2  \to 1/\left< B^2 \right>$
replacement was made.
\end{comment}

The aforementioned problems with the partial and full trajectory models may be eliminated 
in the following manner.
The kinetic equation becomes well behaved if we introduce small particle and heat sources
\begin{equation}
S_a(\psi, v) = S_{ap}(\psi) F_{a}(\psi,v) \left[ x_a^2 - \frac{5}{2}\right] + S_{ah}(\psi) F_a(\psi, v) \left[x_a^2 - \frac{3}{2}\right]
\label{eq:sources}
\end{equation}
where $S_{ap}$ and $S_{ah}$ are considered to be unknowns.
(The $v$ dependence in (\ref{eq:sources}) is chosen so $S_{ap}$ provides a particle source but no heat source, while $S_{ah}$ provides
a heat source but no particle source.)
As these two new unknowns are now included in the system of equations on each flux surface, we must supply an equal number of additional constraints.
The constraints we supply are $\left< \int d^3v\, f_{a1}\right>=0$ and $\left< \int d^3v\, v^2 f_{a1}\right>=0$,
the sensible requirements that all the flux-surface-averaged density and pressure reside in $F_a$ rather than $f_{a1}$.
This method of modifying the system of equations has the added benefit of eliminating the null solutions $f_{a1} = F_a$ and $f_{a1} = F_a v^2$ 
even in the $d\Phi_0/d\psi=0$ limit.
When $S_a$ is included in the kinetic equation, new terms proportional to $S_{ap}$ and/or $S_{ah}$
now appear in the mass and energy conservation equations such as (\ref{eq:unphysicalMassConservation})-(\ref{eq:unphysicalEnergyConservation2}).
These conservation equations imply that when $d\Phi_0/d\psi=0$, $S_{ap}$ and $S_{ah}$ must vanish.
However, now when $d\Phi_0/d\psi$ is increased from 0 to a small finite number, the sources can turn on
to satisfy  (\ref{eq:unphysicalMassConservation})-(\ref{eq:unphysicalEnergyConservation2}),
eliminating the singular perturbation in $f_{a1}$.  We find that numerical results are then well behaved,
converging appropriately as numerical resolution parameters are increased, and smoothly going to the
$E_r=0$ results as $E_r$ is decreased.

We do not claim that the method proposed here is an ideal solution: the sources (\ref{eq:sources})
are ad-hoc and are not derived rigorously. However, by the techniques proposed here, we can at least
compare the three different trajectory models, and for most experimentally relevant values of $E_r$, we will show
that the three models give nearly identical results.

The aforemention mass and energy sources and constraints work when either the Fokker-Planck or momentum-conserving model collision operators
are used, 
but not when the pure pitch-angle scattering collision operator is used, since in this case the kinetic equation has a larger null space
(any function of $v$ is a solution.)
For this collision operator, we instead allow a general source $S_a(\psi,v)$,
introducing $N_x$ unknowns on each flux surface, where $N_x$ is the number of grid points in $v$.
To supply an equal number of constraints, we impose the equations $\left< \int_{-1}^1 d\xi\, f_{a1}\right>=0$
at each grid point in $v$.

\section{Numerical implementation}
\label{sec:numerics}

The SFINCS code solves the drift-kinetic equation (\ref{eq:kinetic4})
with (\ref{eq:sources})
for the three trajectory models (\ref{eq:fullTrajectories})-(\ref{eq:partialTrajectories}),
for general nonaxisymmetric nested flux surface geometry, and for an arbitrary number of species.
SFINCS is based on the Fokker-Planck code described in Ref. \cite{speedGrids},
generalized to allow nonaxisymmetry.
Briefly, the kinetic equation is discretized using finite differences with a 5-point stencil in $\theta$
and $\zeta$, using a truncated Legendre modal expansion in $\xi$, and using
a spectral collocation method in $x_a$.
The time-independent kinetic equation is solved directly (by solving a single sparse linear system),
so the rate of convergence is not limited by the timescale of physical relaxation.
A preconditioned iterative Krylov solver is employed.
The modifications compared to the code of Ref. \cite{speedGrids} are the following.
(1) $f_{a1}$, $B$, and other geometric operators are allowed to depend on the toroidal angle $\zeta$,
and the numerical grid is expanded to include this new coordinate.
(2) The additional $d\Phi_0/d\psi$ terms in $\vect{\dot{r}}_a$, $\dot{x}_a$, and $\dot{\xi}_a$
are included.
(3) The additional collision operators discussed above are included.
(4) The extra constraint equations and sources are implemented as in (19) of Ref. \cite{PERFECT}.

Note that poloidal and toroidal magnetic drifts could be included in the kinetic equation
without increasing the density of the matrix, i.e. without increasing the computational expense
of the method here.  However, to include radial drifts acting on $f_{a1}$,
the number of independent variables would increase from 4 to 5 since different flux surfaces
would couple. This increase in dimensionality would be numerically challenging.

The magnetic geometry is specified in Boozer coordinates $\theta$ and $\zeta$, in which $\vect{B}$
is represented as
\begin{eqnarray}
\vect{B} &=&
\nabla \psi \times \nabla \theta + \iota \nabla\zeta\times\nabla\psi \\
&=& \beta(\psi,\theta,\zeta)\nabla\psi + I(\psi)\nabla\theta + G(\psi) \nabla\zeta.
\end{eqnarray}
Here, $\iota = 1/q$ is the rotational transform with $q$ the safety factor,
$cI/2$ is the toroidal current inside the flux surface, and $cG/2$ is the poloidal
current outside the flux surface.
The geometric operators needed in the kinetic equation are then
\begin{equation}
\vect{B}\cdot\nabla X = \left( \iota \frac{\partial X}{\partial\theta} + \frac{\partial X}{\partial\zeta}\right)\vect{B}\cdot\nabla\zeta
\end{equation}
and
\begin{equation}
\vect{B}\times\nabla\psi\cdot\nabla X = \left( G \frac{\partial X}{\partial\theta} -I \frac{\partial X}{\partial\zeta}\right)\vect{B}\cdot\nabla\zeta
\end{equation}
where $X$ can be any scalar quantity,
and the coordinate Jacobian is
$\vect{B}\cdot\nabla\zeta = B^2/(G+\iota I)$. Thus, the magnetic geometry
enters the kinetic equation only through the quantities $I$, $G$, $\iota$,
and $B(\theta,\zeta)$.

As a test of the code, we have verified the quasisymmetry isomorphism,
discussed in Refs. \cite{Pytte, Boozer83, meQS}.
In this test, the magnetic field is specified as $B(\theta,\zeta) = y(M\theta-N\zeta)$
for some given periodic function $y$ and integers $M$ and $N$.
The kinetic equation is solved for several values of $M$ and $N$,
varying the collision frequency with each run so that
$\nu_{ii} / \left|M - N/\iota \right|$ remains fixed.
As $M$ and $N$ are varied, $G$, $I$, $\iota$, $dn/d\psi$, $dT/d\psi$, and other input quantities are also kept fixed.
Under these circumstances, it is known analytically \cite{Pytte, Boozer83, meQS} that the flow
and heat flux should obey the transformations
\begin{equation}
\left< V_{||} B \right> \frac{M-N/\iota}{NI+MG} = C_V
\end{equation}
and
\begin{equation}
\left< \int d^3v\, f_{i1} \frac{v^2}{2}\vect{v}_{mi}\cdot\nabla\psi \right> \frac{\left| M-N/\iota\right| }{(NI+MG)^2} = C_q
\end{equation}
respectively, where the quantities $C_V$ and $C_q$ should be independent of $M$ and $N$.
It was verified that the SFINCS code obeyed these isomorphism transformations
for a range of $y$, collisionality regimes, and collision operators.

\section{Ion transport matrix}
\label{sec:transportMatrix}

For the case of ions in a pure plasma, it is instructive to examine the transport matrix $L_{jk}$, defined as follows:
\begin{equation}
\label{eq:matrix}
\left(\begin{array}{c}
\frac{Ze(G+\iota I)}{ncTG} \left< \int d^3v\, f \vm\cdot\nabla\psi\right> \\
\frac{Ze(G+\iota I)}{ncTG} \left< \int d^3v\, f \frac{mv^2}{2T}\vm\cdot\nabla\psi\right> \\
\frac{1}{v_i B_0} \left< B V_{||} \right>
\end{array}\right)
=
\left(\begin{array}{ccc}
L_{11} & L_{12} & L_{13} \\
L_{21} & L_{22} & L_{23} \\
L_{31} & L_{32} & L_{33}
\end{array}\right)
\left(\begin{array}{c}
\frac{GTc}{ZeB_0 v_{i}} \left[ \frac{1}{n}\frac{dn}{d\psi} + \frac{Ze}{T}\frac{d\Phi}{d\psi} -\frac{3}{2T}\frac{dT}{d\psi}\right] \\
\frac{GTc}{Ze B_0 v_{i} T}\frac{dT}{d\psi} \\
\frac{Ze}{T}(G+\iota I)\frac{\left<E_{||} B\right>}{\left<B^2\right>}
\end{array}\right)
\end{equation}
Here, $B_0$ is the $(0,0)$ Fourier mode amplitude of $B(\theta,\zeta)$, and we have dropped $i$ subscripts.
When the DKES trajectories (\ref{eq:DKESTrajectories}) are used, it can be shown that $L_{jk}$ is symmetric for any value of $E_r$.
When the trajectories (\ref{eq:fullTrajectories}) or (\ref{eq:partialTrajectories})
are used and $E_r=0$, $L_{jk}$ is symmetric as well. However, when the trajectories (\ref{eq:fullTrajectories}) or (\ref{eq:partialTrajectories}) are used and $E_r \neq 0$,
the transport matrix defined in this manner is generally not symmetric.

Different definitions of the transport matrix have been given elsewhere in the literature \cite{Beidler},
the definition here has several nice properties. First, the matrix is dimensionless. Second, $L_{jk}$ is symmetric (in the cases described above).
Third, $L_{jk}$ depends on the magnetic geometry and physical parameters only through
$B/B_0$, $I/G$, $\iota$, a normalized collisionality
\begin{equation}
\nu' = \frac{(G+\iota I)\nu_{ii}}{v_i B_0},
\end{equation}
and a normalized electric field
\begin{equation}
E_* = \frac{c G}{\iota v_i B_0}\frac{d\Phi_0}{d\psi},
\end{equation}
and not on any other individual parameters such as density, temperature, $I$, etc.
Typically, $I \ll G$ and $G \approx B_0 R$ where $R$ is the major radius of the device,
so $\nu' \approx \nu_{ii} R / v_i$.
In axisymmetry, $E_*$ corresponds to the poloidal Mach number: $E_* \approx (B / B_{pol}) | \vEo | / v_i$
where $B_{pol}$ is the poloidal magnetic field.
Therefore, $E_*$ corresponds to the electric field normalized by the so-called resonant electric field \cite{Beidler}.

Several properties of the matrix $L_{jk}$ are noteworthy. Using the property of the linearized
ion-ion collision operator $\int d^3v (g/F_i) C_{ii}\{g\} \le 0$
for any $g$, then $\sgn(L_{11}) = \sgn(L_{22}) = -\sgn(L_{33}) = -\sgn((G+\iota I)/B_0)$.
\todo{I think this property is true for the FP and PAS operators but not for the model operator.
Confirm this. Also, for the FP and PAS operators, check this for $E_r \ne 0$ for the 3 trajectory models}.
Second, for all three trajectory models, the elements $L_{jk}$
are independent of the sign of the elecric field: $L_{jk}(E_*) = L_{jk}(-E_*)$,
assuming the stellarator symmetry property $B(\theta,\zeta) = B(-\theta,-\zeta)$
for some choice of the origin of $\theta$ and $\zeta$.
This symmetry of $L_{jk}$ follows from a symmetry in the kinetic equation:
if the signs of 
$\theta$, $\zeta$, $v_{||}$, and $d\Phi_0/d\psi$ are all reversed
in (\ref{eq:kinetic4}), the sign of $f_{i1}$ will reverse,
leaving the left-hand side of (\ref{eq:matrix}) unchanged.

\section{Comparison of $E_r$ terms}
\label{sec:ErComparison}

Figures (\ref{fig:ErComparison_LHD}) and (\ref{fig:ErComparison_W7X}) show a SFINCS computation of
the ion transport matrix elements for the 3 trajectory models
in two different stellarator geometries.
The calculations in figure (\ref{fig:ErComparison_LHD}) are performed for the $r/a=0.5$ surface of
the LHD stellarator \cite{LHD} in its standard configuration.
The calculations in figure (\ref{fig:ErComparison_W7X}) are performed for the $r/a=0.5$ surface of
the W7-X stellarator \cite{W7X1,W7X2} in its standard configuration.
In the LHD calculation, only the Boozer harmonics of $B(\theta,\zeta)/B_0$ with amplitude larger than $10^{-2}$
are retained, as listed in Table 1 of Ref. \cite{BeidlerBigBenchmarking}.
For both figures, the Fokker-Planck collision operator is used, and the collisionality
is set to $\nu'=0.01$.
As both figures illustrate, the electric field has negligible
effect on the transport matrix elements when $E_* < 0.01$.
For these small values of the electric field, the radial step size for diffusion is 
limited by collisions rather than by $\vect{E}\times\vect{B}$ precession.
As $E_r \to 0$, all the matrix elements converge smoothly to their $E_r=0$ limits.
For $E_*$ in the range $[0.01, 0.3]$,
the $\vect{E}\times\vect{B}$ precession suppresses radial transport,
as can be seen by the reduction in $|L_{11}|$ and $|L_{22}|$. In this regime of $E_*$, the three trajectory models give nearly
identical results for all the transport matrix elements.
However, once $E_*$ exceeds about 0.3, the results from the three trajectory models
begin to separate. 
%Roughly, the poloidal $\vect{E}\times\vect{B}$ will limit the radial step size for diffusion
%when $E_* > \nu'$, and this prediction is confirmed
\todo{Can we say anything about why the three trajectory models agree below the resonance? 
How large is $E_*$ likely to be in W7X and LHD?}

To ensure convergence with respect to the numerical resolution parameters $N_{\theta}$, $N_{\zeta}$, $N_{\xi}$ and $N_x$,
it was verified that the plotted curves did not change visibly on the scales shown
when each of these resolution parameters was doubled.


\todo{Add an example (with figure) involving more than 1 species. Perhaps compute $j_{bs}$ vs $E_r$ for different $E_r$ models at 1 or 2 values of nu*, perhaps assuming $L_n = L_{Te} = L_{Ti}, E||=0.$}


\begin{figure}[h!]
% Figure generated using m20131202_01_plotSFINCSErComparisonForPaper.m
% Data files:
% m20130324_01_SFINCS_ErScan_2013-03-27_03-59_ErScan_awesomer_mergeder.mat
% Code run on Matt's laptop
% *********************************
\includegraphics{m20131202_01_plotSFINCSErComparisonForPaper_LHD.eps}
%\includegraphics{m20131202_01_plotSFINCSErComparisonForPaper_LHD.pdf}
\caption{(Color online) Comparison of trajectory models for LHD standard geometry at $\nu' = 0.01$,
using linearized Fokker-Planck collisions.
\label{fig:ErComparison_LHD}}
\end{figure}

\begin{figure}[h!]
% Figure generated using m20131202_01_plotSFINCSErComparisonForPaper.m
% Data files:
% sfincs_2013-12-01_15-49_ErScan_noConvergence
% Code run on edison in 
% *********************************
\includegraphics{m20131202_01_plotSFINCSErComparisonForPaper_W7X.eps}
%\includegraphics{m20131202_01_plotSFINCSErComparisonForPaper_W7X.pdf}
\caption{(Color online) Comparison of trajectory models for W7X standard geometry at $\nu' = 0.01$,
using linearized Fokker-Planck collisions.
\todo{Fill in points for $E_*$ in the range 0.1 to 1.}
\label{fig:ErComparison_W7X}}
\end{figure}











\section{Comparison of collision operators}
\label{sec:collisionComparison}

Figures (\ref{fig:collisionComparison_LHD})-(\ref{fig:collisionComparison_W7X}) show the transport
matrix elements for the LHD and W7X geometries described earlier, this time comparing
the different collision operators as a function of collisionality.
The comparison is done for $d\Phi_0/d\psi=0$, so the three trajectory models
become identical, and the sources $S_a$ vanish.
It can be seen in the figures that at high collisionality,
momentum conservation is important for all the transport matrix elements (with the possible exception of $L_{22}$.)
At low collisionality, momentum conservation 
is unimportant for $L_{11}$, $L_{12}$, $L_{21}$, and $L_{22}$.
These matrix elements are associated with $1/\nu$-regime radial transport
(when $\nu' \ll 1$), which is associated with pitch-angle scattering of helically trapped particles.
Thus, the pitch-angle scattering approximation for collisions accurately
captures the dominant physics in these cases.
The other matrix elements are more sensitive to momentum conservation at low collisionality.
For all the matrix elements at all collisionalities, the momentum-conserving model operator
reproduces all the trends of the more accurate linearized Fokker-Planck operator,
though with some $O(1)$ differences.


Again, to ensure convergence with respect to the numerical resolution parameters $N_{\theta}$, $N_{\zeta}$, $N_{\xi}$ and $N_x$,
it was verified that the plotted curves did not change visibly on the scales shown
when each of these resolution parameters was doubled.
The required resolution in the $\zeta$ and $\xi$ coordinates increases substantially
as $\nu'$ decreases, due to the boundary layers that develop in the distribution function.

\begin{figure}[h!]
% Figure generated using m20131130_01_plotSFINCSCollisionOperatorComparisonForPaper.m
% Data files:
% m20131117_04_sfincs_w7x_2013-11-26_02-27_nuPrimeScan_nuPrime0_01to100
% m20130226_04_SFINCS_2013-02-26_21-21_good
% W7X run was on edison in /global/scratch2/sd/landrema/20131123-01-sfincs/20131125-02-nuPrimeScan0_01to100
% *********************************
\includegraphics{m20131130_01_plotSFINCSCollisionOperatorComparisonForPaper_LHD.eps}
%\includegraphics{m20131130_01_plotSFINCSCollisionOperatorComparisonForPaper_LHD.pdf}
\caption{(Color online) Comparison of collision operators for LHD standard geometry at $E_r=0$.
\todo{Extend plots to $\nu' = 10^{-3}$.}
\label{fig:collisionComparison_LHD}}
\end{figure}

\begin{figure}[h!]
% Figure generated using m20131130_01_plotSFINCSCollisionOperatorComparisonForPaper.m
% Data files:
% m20131117_04_sfincs_w7x_2013-11-26_02-27_nuPrimeScan_nuPrime0_01to100
% m20130226_04_SFINCS_2013-02-26_21-21_good
% W7X run was on edison in /global/scratch2/sd/landrema/20131123-01-sfincs/20131125-02-nuPrimeScan0_01to100
% *********************************
\includegraphics{m20131130_01_plotSFINCSCollisionOperatorComparisonForPaper_W7X.eps}
%\includegraphics{m20131130_01_plotSFINCSCollisionOperatorComparisonForPaper_W7X.pdf}
\caption{(Color online) Comparison of collision operators for W7X standard geometry at $E_r=0$.
\todo{Extend plots to $\nu' = 10^{-3}$.}
\label{fig:collisionComparison_W7X}}
\end{figure}

%\todo{Add an example (with figure) involving more than 1 species. Perhaps compute $j_{bs}$ vs nu* for different collision operators at $E_r=0$, perhaps assuming $L_n = L_{Te} = L_{Ti}, E||=0.$}

\begin{comment}
\begin{table}
\centering
\begin{tabular}{c c c c c}
$\nu_n$ & $N_\theta$ & $N_\zeta$ & $N_\xi$ & $N_x$ \\
\hline
100 & 11 & 37 & 13 & 8 \\
10 & 13 & 35 & 12 & 7 \\
1 & 13 & 31 & 24 & 6 \\
0.1 & 11 & 37 & 37 & 5 \\
0.01 & 11 & 64 & 68 & 5 \\
0.001 & 11 & 83 & 122 & 5 \\
%\begin{tabular}{c c c c c c c}
%$\nu_n$ & 0.001 & 0.01 & 0.1 & 1 & 10 & 100 \\
\end{tabular}
\caption{Resolution parameters required for convergence in the W7-X examples.
\label{tab:resolution}}
\end{table}
\end{comment}

\section{Discussion and conclusions}
\label{sec:conclusions}

\todo{Write this section}



\begin{acknowledgments}
Some of the computer simulations presented here
used resources of the National Energy Research Scientific Computing Center (NERSC),
which is supported by the Office of Science of the U.S. Department of Energy under Contract No. DE-AC02-05CH11231.
M. L. was supported by the
Fusion Energy Postdoctoral Research Program
administered by the Oak Ridge Institute for Science and Education.
We are grateful to J. Geiger for providing the W7X equilibrium data.
\end{acknowledgments}


%\appendix
%\section{Any appendix would go here}


\bibliography{sfincsPaper}


\end{document}

% To do:
% * Add references to other stellarator codes in intro.
% * Write conclusions
% * Finish E* scan for W7X
% * Figure out multi-species model operator
% * Write section on collision operators
% * Should I include any results showing ripple?
% * Think of a good example involving >1 species.
% * Paragraph that L_jk is invariant under EStar -> - EStar, L_11 and L_22 are negative, and L12=L21 for full trajectories even when E \ne 0.
